<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epicentra Bildirim Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔔 Epicentra Bildirim Sistemi Test</h1>
    
    <div class="test-section">
        <h2>1. Push Notification İzinleri</h2>
        <button class="test-button" onclick="requestNotificationPermission()">Bildirim İzni İste</button>
        <div id="permission-status" class="status info">İzin durumu kontrol ediliyor...</div>
    </div>
    
    <div class="test-section">
        <h2>2. Service Worker Kaydı</h2>
        <button class="test-button" onclick="registerServiceWorker()">Service Worker Kaydet</button>
        <div id="sw-status" class="status info">Service Worker durumu kontrol ediliyor...</div>
    </div>
    
    <div class="test-section">
        <h2>3. FCM Token Alma</h2>
        <button class="test-button" onclick="getFCMToken()">FCM Token Al</button>
        <div id="token-status" class="status info">Token durumu kontrol ediliyor...</div>
    </div>
    
    <div class="test-section">
        <h2>4. Test Bildirimi Gönder</h2>
        <button class="test-button" onclick="sendTestNotification()">Test Bildirimi Gönder</button>
        <div id="test-status" class="status info">Test bildirimi hazır...</div>
    </div>
    
    <div class="test-section">
        <h2>5. Bildirim Ayarları</h2>
        <label>
            <input type="checkbox" id="sound-enabled" checked> Sesli Uyarı
        </label><br>
        <label>
            <input type="checkbox" id="vibration-enabled" checked> Titreşim
        </label><br>
        <label>
            Minimum Büyüklük: 
            <select id="min-magnitude">
                <option value="2.0">2.0+</option>
                <option value="2.5">2.5+</option>
                <option value="3.0" selected>3.0+</option>
                <option value="3.5">3.5+</option>
                <option value="4.0">4.0+</option>
            </select>
        </label>
    </div>
    
    <div class="test-section">
        <h2>📋 Test Logları</h2>
        <div id="log" class="log"></div>
        <button class="test-button" onclick="clearLog()">Logları Temizle</button>
    </div>

    <script>
        let fcmToken = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }
        
        // 1. Push Notification İzinleri
        async function requestNotificationPermission() {
            try {
                log('Bildirim izni isteniyor...');
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    updateStatus('permission-status', '✅ Bildirim izni verildi!', 'success');
                    log('✅ Bildirim izni verildi');
                } else {
                    updateStatus('permission-status', '❌ Bildirim izni reddedildi', 'error');
                    log('❌ Bildirim izni reddedildi');
                }
            } catch (error) {
                updateStatus('permission-status', '❌ Hata: ' + error.message, 'error');
                log('❌ İzin hatası: ' + error.message);
            }
        }
        
        // 2. Service Worker Kaydı
        async function registerServiceWorker() {
            try {
                log('Service Worker kaydediliyor...');
                
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    updateStatus('sw-status', '✅ Service Worker kaydedildi!', 'success');
                    log('✅ Service Worker kaydedildi: ' + registration.scope);
                    
                    // Push Manager kontrol et
                    if (registration.pushManager) {
                        log('✅ Push Manager mevcut');
                    } else {
                        log('❌ Push Manager mevcut değil');
                    }
                } else {
                    updateStatus('sw-status', '❌ Service Worker desteklenmiyor', 'error');
                    log('❌ Service Worker desteklenmiyor');
                }
            } catch (error) {
                updateStatus('sw-status', '❌ Hata: ' + error.message, 'error');
                log('❌ Service Worker hatası: ' + error.message);
            }
        }
        
        // 3. FCM Token Alma
        async function getFCMToken() {
            try {
                log('FCM Token alınıyor...');
                
                // VAPID public key al
                const vapidResponse = await fetch('/api/push/vapid-public-key');
                const vapidData = await vapidResponse.json();
                
                if (!vapidData.publicKey) {
                    throw new Error('VAPID public key alınamadı');
                }
                
                log('✅ VAPID key alındı');
                
                // Service Worker'ı bekle
                const registration = await navigator.serviceWorker.ready;
                
                // Push subscription oluştur
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidData.publicKey)
                });
                
                // Token'ı server'a gönder
                const response = await fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subscription: subscription,
                        userSettings: {
                            minMag: parseFloat(document.getElementById('min-magnitude').value),
                            cityFilter: '',
                            active: true
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    fcmToken = subscription.endpoint;
                    updateStatus('token-status', '✅ FCM Token başarıyla kaydedildi!', 'success');
                    log('✅ FCM Token kaydedildi: ' + fcmToken.substring(0, 50) + '...');
                } else {
                    throw new Error(result.message || 'Token kaydedilemedi');
                }
                
            } catch (error) {
                updateStatus('token-status', '❌ Hata: ' + error.message, 'error');
                log('❌ FCM Token hatası: ' + error.message);
            }
        }
        
        // 4. Test Bildirimi Gönder
        async function sendTestNotification() {
            try {
                log('Test bildirimi gönderiliyor...');
                
                const response = await fetch('/api/push/test-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        magnitude: 4.5,
                        city: 'Test Şehir',
                        district: 'Test İlçe',
                        depth: 10
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('test-status', '✅ Test bildirimi gönderildi!', 'success');
                    log('✅ Test bildirimi gönderildi: M' + result.earthquake.Magnitude);
                } else {
                    throw new Error(result.message || 'Test bildirimi gönderilemedi');
                }
                
            } catch (error) {
                updateStatus('test-status', '❌ Hata: ' + error.message, 'error');
                log('❌ Test bildirimi hatası: ' + error.message);
            }
        }
        
        // VAPID key'i Uint8Array'e çevir
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        // Sayfa yüklendiğinde otomatik test
        window.addEventListener('load', () => {
            log('🚀 Epicentra Bildirim Test Sayfası Yüklendi');
            log('📱 Tarayıcı: ' + navigator.userAgent);
            log('🔔 Notification API: ' + ('Notification' in window ? 'Mevcut' : 'Mevcut değil'));
            log('⚙️ Service Worker: ' + ('serviceWorker' in navigator ? 'Mevcut' : 'Mevcut değil'));
            log('📡 Push Manager: ' + ('PushManager' in window ? 'Mevcut' : 'Mevcut değil'));
            
            // Mevcut izin durumunu kontrol et
            if (Notification.permission === 'granted') {
                updateStatus('permission-status', '✅ Bildirim izni zaten verilmiş', 'success');
            } else if (Notification.permission === 'denied') {
                updateStatus('permission-status', '❌ Bildirim izni reddedilmiş', 'error');
            } else {
                updateStatus('permission-status', '⏳ Bildirim izni bekleniyor', 'info');
            }
        });
    </script>
</body>
</html>
