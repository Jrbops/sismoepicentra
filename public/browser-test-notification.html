<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epicentra Bildirim Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”” Epicentra Bildirim Sistemi Test</h1>
    
    <div class="test-section">
        <h2>1. Push Notification Ä°zinleri</h2>
        <button class="test-button" onclick="requestNotificationPermission()">Bildirim Ä°zni Ä°ste</button>
        <div id="permission-status" class="status info">Ä°zin durumu kontrol ediliyor...</div>
    </div>
    
    <div class="test-section">
        <h2>2. Service Worker KaydÄ±</h2>
        <button class="test-button" onclick="registerServiceWorker()">Service Worker Kaydet</button>
        <div id="sw-status" class="status info">Service Worker durumu kontrol ediliyor...</div>
    </div>
    
    <div class="test-section">
        <h2>3. FCM Token Alma</h2>
        <button class="test-button" onclick="getFCMToken()">FCM Token Al</button>
        <div id="token-status" class="status info">Token durumu kontrol ediliyor...</div>
    </div>
    
    <div class="test-section">
        <h2>4. Test Bildirimi GÃ¶nder</h2>
        <button class="test-button" onclick="sendTestNotification()">Test Bildirimi GÃ¶nder</button>
        <div id="test-status" class="status info">Test bildirimi hazÄ±r...</div>
    </div>
    
    <div class="test-section">
        <h2>5. Bildirim AyarlarÄ±</h2>
        <label>
            <input type="checkbox" id="sound-enabled" checked> Sesli UyarÄ±
        </label><br>
        <label>
            <input type="checkbox" id="vibration-enabled" checked> TitreÅŸim
        </label><br>
        <label>
            Minimum BÃ¼yÃ¼klÃ¼k: 
            <select id="min-magnitude">
                <option value="2.0">2.0+</option>
                <option value="2.5">2.5+</option>
                <option value="3.0" selected>3.0+</option>
                <option value="3.5">3.5+</option>
                <option value="4.0">4.0+</option>
            </select>
        </label>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“‹ Test LoglarÄ±</h2>
        <div id="log" class="log"></div>
        <button class="test-button" onclick="clearLog()">LoglarÄ± Temizle</button>
    </div>

    <script>
        let fcmToken = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }
        
        // 1. Push Notification Ä°zinleri
        async function requestNotificationPermission() {
            try {
                log('Bildirim izni isteniyor...');
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    updateStatus('permission-status', 'âœ… Bildirim izni verildi!', 'success');
                    log('âœ… Bildirim izni verildi');
                } else {
                    updateStatus('permission-status', 'âŒ Bildirim izni reddedildi', 'error');
                    log('âŒ Bildirim izni reddedildi');
                }
            } catch (error) {
                updateStatus('permission-status', 'âŒ Hata: ' + error.message, 'error');
                log('âŒ Ä°zin hatasÄ±: ' + error.message);
            }
        }
        
        // 2. Service Worker KaydÄ±
        async function registerServiceWorker() {
            try {
                log('Service Worker kaydediliyor...');
                
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    updateStatus('sw-status', 'âœ… Service Worker kaydedildi!', 'success');
                    log('âœ… Service Worker kaydedildi: ' + registration.scope);
                    
                    // Push Manager kontrol et
                    if (registration.pushManager) {
                        log('âœ… Push Manager mevcut');
                    } else {
                        log('âŒ Push Manager mevcut deÄŸil');
                    }
                } else {
                    updateStatus('sw-status', 'âŒ Service Worker desteklenmiyor', 'error');
                    log('âŒ Service Worker desteklenmiyor');
                }
            } catch (error) {
                updateStatus('sw-status', 'âŒ Hata: ' + error.message, 'error');
                log('âŒ Service Worker hatasÄ±: ' + error.message);
            }
        }
        
        // 3. FCM Token Alma
        async function getFCMToken() {
            try {
                log('FCM Token alÄ±nÄ±yor...');
                
                // VAPID public key al
                const vapidResponse = await fetch('/api/push/vapid-public-key');
                const vapidData = await vapidResponse.json();
                
                if (!vapidData.publicKey) {
                    throw new Error('VAPID public key alÄ±namadÄ±');
                }
                
                log('âœ… VAPID key alÄ±ndÄ±');
                
                // Service Worker'Ä± bekle
                const registration = await navigator.serviceWorker.ready;
                
                // Push subscription oluÅŸtur
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidData.publicKey)
                });
                
                // Token'Ä± server'a gÃ¶nder
                const response = await fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subscription: subscription,
                        userSettings: {
                            minMag: parseFloat(document.getElementById('min-magnitude').value),
                            cityFilter: '',
                            active: true
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    fcmToken = subscription.endpoint;
                    updateStatus('token-status', 'âœ… FCM Token baÅŸarÄ±yla kaydedildi!', 'success');
                    log('âœ… FCM Token kaydedildi: ' + fcmToken.substring(0, 50) + '...');
                } else {
                    throw new Error(result.message || 'Token kaydedilemedi');
                }
                
            } catch (error) {
                updateStatus('token-status', 'âŒ Hata: ' + error.message, 'error');
                log('âŒ FCM Token hatasÄ±: ' + error.message);
            }
        }
        
        // 4. Test Bildirimi GÃ¶nder
        async function sendTestNotification() {
            try {
                log('Test bildirimi gÃ¶nderiliyor...');
                
                const response = await fetch('/api/push/test-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        magnitude: 4.5,
                        city: 'Test Åehir',
                        district: 'Test Ä°lÃ§e',
                        depth: 10
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('test-status', 'âœ… Test bildirimi gÃ¶nderildi!', 'success');
                    log('âœ… Test bildirimi gÃ¶nderildi: M' + result.earthquake.Magnitude);
                } else {
                    throw new Error(result.message || 'Test bildirimi gÃ¶nderilemedi');
                }
                
            } catch (error) {
                updateStatus('test-status', 'âŒ Hata: ' + error.message, 'error');
                log('âŒ Test bildirimi hatasÄ±: ' + error.message);
            }
        }
        
        // VAPID key'i Uint8Array'e Ã§evir
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        // Sayfa yÃ¼klendiÄŸinde otomatik test
        window.addEventListener('load', () => {
            log('ğŸš€ Epicentra Bildirim Test SayfasÄ± YÃ¼klendi');
            log('ğŸ“± TarayÄ±cÄ±: ' + navigator.userAgent);
            log('ğŸ”” Notification API: ' + ('Notification' in window ? 'Mevcut' : 'Mevcut deÄŸil'));
            log('âš™ï¸ Service Worker: ' + ('serviceWorker' in navigator ? 'Mevcut' : 'Mevcut deÄŸil'));
            log('ğŸ“¡ Push Manager: ' + ('PushManager' in window ? 'Mevcut' : 'Mevcut deÄŸil'));
            
            // Mevcut izin durumunu kontrol et
            if (Notification.permission === 'granted') {
                updateStatus('permission-status', 'âœ… Bildirim izni zaten verilmiÅŸ', 'success');
            } else if (Notification.permission === 'denied') {
                updateStatus('permission-status', 'âŒ Bildirim izni reddedilmiÅŸ', 'error');
            } else {
                updateStatus('permission-status', 'â³ Bildirim izni bekleniyor', 'info');
            }
        });
    </script>
</body>
</html>
